'use strict';

const Axios = require('axios');

const MySimpleClass = require('../myLayer/SimpleClass');

module.exports = class HttpAPI extends MySimpleClass {

  #axios;
  #baseURL;

  constructor(owner, baseURL) {
    super(owner);

    this.#axios = Axios.create();
    this.setBaseURL(baseURL);
    this._initInterceptors();

    this.logDebug('Initialized');
  }

  setBaseURL(baseURL) {
    this.#baseURL = baseURL;
  }

  get(url, config = {}) {
    config = { baseURL: this.#baseURL, ...config };
    return this.#axios.get(url, config)
      .then((response) => response.data);
  }

  post(url, data, config = {}) {
    if (data !== null) {
      switch (typeof data) {
        case 'string':
          config.headers = { 'Content-Type': 'text/plain' };
          break;
        case 'object':
          config.headers = { 'Content-Type': 'application/json' };
          break;
        default:
      }
    }
    config = { baseURL: this.#baseURL, ...config };
    return this.#axios.post(url, data, config)
      .then((response) => response.data);
  }

  put(url, data, config = {}) {
    config = { baseURL: this.#baseURL, ...config };
    return this.#axios.put(url, data, config)
      .then((response) => response.data);
  }

  delete(url, config = {}) {
    config = { baseURL: this.#baseURL, ...config };
    return this.#axios.delete(url, config)
      .then((response) => response.data);
  }

  _initInterceptors() {
    // this.logDebug("_initInterceptors()");
    this.#axios.interceptors.request.use(
      (config) => {
        if (config._callOnce) return config;
        config._callOnce = true;

        const msgPrefix = `${config.method.toUpperCase()} -> '${config.url}'`;
        this.logDebug(`${msgPrefix} ${config.data ? `- ${JSON.stringify(config.data)}` : ''}`);
        return config;
      },
      (error) => {
        if (error._callOnce) return Promise.reject(error);
        error._callOnce = true;

        const msgPrefix = `${error.request.method.toUpperCase()} '${error.request.url}' > `;
        this.logError(`${msgPrefix} ${error.message}`);

        // Show the error only in the debug mode.
        if (process.env.DEBUG === '1') {
          this.logError(`${msgPrefix} > ${error.request}`);
        }
        return Promise.reject(error);
      },
    );

    this.#axios.interceptors.response.use(
      (response) => {
        if (response._callOnce) return response;
        response._callOnce = true;

        const msgPrefix = `${response.config.method.toUpperCase()} <- '${response.config.url}'`;
        this.logDebug(`${msgPrefix} ${response.data ? `- ${JSON.stringify(response.data)}` : ''}`);

        return response;
      },
      (error) => {
        if (error._callOnce) return Promise.reject(error);
        error._callOnce = true;

        const statusCode = error.response ? error.response.status : null;
        const msgPrefix = `${error.config.method.toUpperCase()} '${error.config.url}' > `;
        this.logError(`${msgPrefix} ${error.message}`);

        // Show the error only in the debug mode.
        if (process.env.DEBUG === '1') {
          this.logError(`${msgPrefix} url: ${error.config.baseURL.concat(error.config.url)}`);
          this.logError(`${msgPrefix} status: ${statusCode}`);
          if (error.response) {
            this.logError(`${msgPrefix} data: ${error.response.data}`);
            this.logError(`${msgPrefix} headers: ${JSON.stringify(error.response.headers)}`);
          }
        }

        switch (statusCode) {
          case 401:
            // utils.redirectTo("/login")
            break;
          case 404:
            // return Promise.reject(Error(`${error.config.url} not found`));
            break;
          default:
            break;
        }

        return Promise.reject(error);
      },
    );
  }

};
